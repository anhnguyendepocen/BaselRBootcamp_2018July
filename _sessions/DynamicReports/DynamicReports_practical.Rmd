---
title: "Dynamic Reports"
subtitle: "With RMarkdown"
author: "BaselRBootcamp July 2018<br/><a href='https://therbootcamp.github.io'>www.therbootcamp.com</a><br/><a href='https://twitter.com/therbootcamp'>@therbootcamp</a>"
output:
  html_document:
    css: practical.css
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(comment = NA, 
                      fig.width = 6, 
                      fig.height = 6,
                      fig.align = 'center',
                      echo = FALSE, 
                      eval = FALSE, 
                      warning = FALSE)

options(digits = 3)

library(baselers)
library(tidyverse)
```


<figure>
<center>
  <img src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2014/09/Caret-package-in-R.png" alt="Trulli" style="width:70%">
  <figcaption>www.rstudio.com</figcaption>
</figure>


## Overview

By the end of this practical you will know how to:

1. Create a new R Markdown file (`.Rmd`)
2. "Knit" an R Markdown file to an .html or .pdf report
3. Format text using formatting tags
4. Create code chunks
5. Include code output in sentences with inline chunks

## Packages

|Package| Installation|
|:------|:------|
|`tidyverse`|`install.packages("tidyverse")`|
|`knitr`|`install.packages("knitr")`|
|`DT`|`install.packages("DT")`|
|`broom`|`install.packages("broom")`|
|`rmdformats`|`install.packages("rmdformats")`|
|`xaringan`|`install.packages("xaringan")`|

### Cheatsheet

<a href="https://www.rstudio.com/wp-content/uploads/2015/02/rmarkdown-cheatsheet.pdf">
  <center><img src="http://westandproud.info/wp-content/uploads/2018/04/reproducible-and-interactive-research-with-regard-to-cheat-sheet-r-markdown.png" width="600px">
</a>

## Datasets

```{r, eval = TRUE, message = FALSE}
library(tidyverse)
mcdonalds <- read_csv("https://raw.githubusercontent.com/therbootcamp/BaselRBootcamp_2018July/master/_sessions/_data/complete/mcdonalds.csv")
```

|File  |Rows | Columns |
|:----|:-----|:------|
|[mcdonalds.csv](https://raw.githubusercontent.com/therbootcamp/BaselRBootcamp_2018July/master/_sessions/_data/complete/mcdonalds.csv)| 260 | 24 |

## Tasks

## A - Setup

1. Open your R project. It should already have the folders `0_Data` and `1_Code`. Make sure that the data files listed in the `Datasets` section above are in your `1_Data` folder

```{r}
# Done!
```

2. Because R Markdown looks quite a bit different from standard R code, the best way to look at examples is to see a new R Markdown document in action. In RStudio, click File -- New File -- R Markdown

```{r, echo = FALSE, fig.align = 'center', eval = TRUE, out.width = "60%"}
knitr::include_graphics("https://raw.githubusercontent.com/therbootcamp/therbootcamp.github.io/master/_sessions/_image/rmarkdown_ss_A.png")
```

3.  Give the document a title and an author. For the output format, select HTML (the default). Click Ok!

```{r, echo = FALSE, fig.align = 'center', eval = TRUE, out.width = "60%"}
knitr::include_graphics("https://raw.githubusercontent.com/therbootcamp/therbootcamp.github.io/master/_sessions/_image/rmarkdown_ss_B.png")
```

4. A new file that looks like this should open up. This is your first R Markdown document!

```{r, echo = FALSE, fig.align = 'center', eval = TRUE, out.width = "60%"}
knitr::include_graphics("https://raw.githubusercontent.com/therbootcamp/therbootcamp.github.io/master/_sessions/_image/rmarkdown_ss_C.png")
```

5. Save your markdown file *in your main project directory* (not in the `4_Markdown` folder! -- you'll put it there later!) under the name `mcdonalds.Rmd`

6. Now *knit* your document to an HTML file. To do this, click the *knit* button (or use the Command + Shift + K shortcut)

```{r, echo = FALSE, fig.align = 'center', eval = TRUE, out.width = "60%"}
knitr::include_graphics("https://raw.githubusercontent.com/therbootcamp/therbootcamp.github.io/master/_sessions/_image/rmarkdown_ss_D.png")
```

7. Now you should see your final, HTML document! Scroll up and down the document and see how she looks!

```{r, echo = FALSE, fig.align = 'center', eval = TRUE, out.width = "60%"}
knitr::include_graphics("https://raw.githubusercontent.com/therbootcamp/therbootcamp.github.io/master/_sessions/_image/rmarkdown_ss_E.png")
```

## B - Load packages and data

1. You should always start your markdown file by loading packages and data in a code chunk. We'll do this inside of the first chunk with the `setup` label. Inside of this chunk, write the comment `# Load Packages -------------`. Then, using the `library()` function, load the packages listed in the `Packages` section above. 

```{r, echo = FALSE, fig.align = 'center', eval = TRUE, out.width = "50%"}
knitr::include_graphics("https://raw.githubusercontent.com/therbootcamp/therbootcamp.github.io/master/_sessions/_image/setup_chunk.jpg")
```

2. Knit your document! Make sure you don't get any errors!

3. Now it's time to load your datafiles. In the *same* `setup` chunk, load each of the data files listed in the `Datasets` section. 

```{r, eval = FALSE}
# --- Load packages
library(XX)
library(XX)

# --- Load data
XXX <- read_csv()
XXX <- read_csv()
```

4. Knit your document! Make sure you don't get any errors!

5. Now it's time to change some of the default chunk options. 


5. 



8. In the first code chunk (with the label `setup`), include the following code: the arguments in`knitr::opts_chunk$set()` will set your global chunk options, while finally, `options(digits = 2)` makes sure that all of your numeric output is rounded to two decimal places.

```{r, eval = FALSE, echo = TRUE}
# INCLUDE ALL OF THIS CODE IN YOUR FIRST CHUNK!

knitr::opts_chunk$set(fig.width = 6,        # Figure width (in)
                      fig.height = 6,       # Figure height (in)
                      echo = TRUE,          # Repeat code
                      eval = TRUE,          # Evaluate chunks
                      message = FALSE,      # Don't print messages
                      warning = FALSE,      # Don't print warnings
                      fig.align = 'center') # Center figures

options(digits = 2)  # Round all output to 2 digits
```

9. Knit your document! Make sure you see an output!


14. Add the necessary text and markdown to your document to create the following two paragraphs. Pay attention to the header sizes, *italics* and `code` formats.

```{r, fig.cap = "Write the necessary markdown to create this output!", eval = TRUE, echo = FALSE, out.width = "75%"}
knitr::include_graphics("https://raw.githubusercontent.com/therbootcamp/therbootcamp.github.io/master/_sessions/_image/markdown_output_ss.png")
```

15. Knit the document! Diagnose and correct any errors!

16. Add the appropriate combination of text, markdown, code chunks, and R code to add the following output to your document. To report the number of patients, use an in-line chunk to access the number directly from the data using the `nrow()` function, -- that is, don't type 2139 directly! To create the table, create a new chunk, and inside that chunk, use the `kable()` function, with the appropriate arguments, to create the table. The following code might help you create the table:

```{r, echo = FALSE, out.width = "75%", eval = TRUE}
knitr::include_graphics("https://raw.githubusercontent.com/therbootcamp/therbootcamp.github.io/master/_sessions/_image/markdown_analysis_ss.png")
```


```{r, eval = FALSE, echo = TRUE}
# Code for Table 1:

trial_act %>%
  select(pidnum, age, wtkg, hemo, homo) %>%
  select(1:5) %>%
  slice(1:5) %>%
  kable(caption = "Table 1: XXX")
```

17. Knit the document! Diagnose and correct any errors!

15. Write the necessary code to add the following output to your document. To do this, create a new chunk. In the chunk use `dplyr` code to create the summary table of data. Assign the result to the object `trial_summary`. Then, use `kable()` to render this dataframe as a table in the final document.

```{r, echo = FALSE, out.width = "75%", eval = TRUE}
knitr::include_graphics("https://raw.githubusercontent.com/therbootcamp/therbootcamp.github.io/master/_sessions/_image/markdown_analysis_ss_B.png")
```

Here is some code you might find helpful in creating this table!

```{r, echo = TRUE, eval = FALSE}
# Helpful code to create the summary table!

trial_act %>% 
    group_by(XX) %>% 
    summarise(N = n(),
              Mean = mean(XX),
              Median = median(XX),
              SD = sd(XX),
              Max = max(XX)) %>%
  kable(caption = "Table 2: XXX")
```

16. Knit the document! Diagnose and correct any errors!

17. Add the appropriate combination of text, markdown, code chunks, and R code to add the following output to your document. Be sure to include the figure caption (you can do this with the `fig.cap` argument to the chunk)

```{r, echo = FALSE, out.width = "75%", eval = TRUE}
knitr::include_graphics("https://raw.githubusercontent.com/therbootcamp/therbootcamp.github.io/master/_sessions/_image/markdown_ggplot_ss.png")
```

This code might help you to create the plot:

```{r, eval = FALSE, echo = TRUE}
# Boxplot code template

ggplot(data = XX, 
       mapping = aes(x = factor(XX), y = XX)) +
  geom_boxplot() + 
  labs(x = "XX",
       y = "XX",
       title = "XX",
       subtitle = "XX",
       caption = "XX") + 
  theme_bw()
```

18. Knit the document! Diagnose and correct any errors!

19. A researcher wants to know if there is a correlation between patients' CD4 T cell count at baseline (`cd40`) and the number of days until a major negative event.  Include this information as a new subsection (with a second level header) in your analyses. To do this, run the following chunk. Then, write a sentence with the main outputs from the test, using inline chunks to directly access the correlation and the p-value. For example, a sentence could be: "The correlation between CD4 T cell count at baseline and number of days until a major negative event was r = XX, p = YY".

```{r, eval = FALSE, echo = TRUE}
# Correlation test between cd40 and days

cd4_cor <- cor.test(formula = ~ XX + XX,
                    data = XX)

cd4_cor_r <- cd4_cor$XX  # Get the correlation
cd4_cor_p <- cd4_cor$XX   # Get the p-value
```

20. In addition to the correlation test, include a relevant scatterplot showing the relationship between CD4 T cell count at baseline (`cd40`) and number of days until a major negative event (`days`).

21. Add a new section called "Conclusions". Write the main conclusions of your analyses in one or two sentences. Feel free to add some formatting and/or in-line chunks to your content!

## Managing working directories with Markdown

22. Now it's time to move your Markdown file to your `4_Markdown` folder. Move your `speffanalysis.Rmd` file to your `4_Markdown` folder using your computer file browser (Finder on Mac, Windows explorer on PC). Now, try knitting your document. You should get an error! What happened?!

23. The problem is that when you knit your Markdown file, R changes your working directory to the folder where your markdown file is located. However, now that you moved your file to your `4_Markdown` folder, this isn't true anymore. You need to tell Markdown that the root directory of your project is one directory up! Thankfully this is easy to do. Just add the following code to your initial `setup` R chunk:

```{r, echo = TRUE}
# Tell R Markdown that the root directory is now one folder
#   up from the folder the markdown file is in

knitr::opts_knit$set(root.dir = "../")
```

24. Knit your document! Did everything work? If not, try to correct the working directory issues. Don't be afraid to ask for help!

25. If you have LaTex installed on your computer, try knitting your document to PDF format by clicking the Knit button and knit to PDF. If you don't have LaTeX installed, don't worry :)

## Other Markdown templates

26. Don't like the standard markdown template? You can get many other templates from the `rmdformats` package. Install the package with `rmdformats`. Then create a new markdown file from one of the temples with File -- New File -- R Markdown -- From Template. Try the `HTML readthedown` template. Knit the document and see how it looks different from your standard template.

## Slideshow

```{r, eval = TRUE, echo = FALSE, out.width = "50%"}
knitr::include_graphics("https://raw.githubusercontent.com/therbootcamp/therbootcamp.github.io/master/_sessions/_image/xaringan_ss.png")
```

27. Now it's time to create a slideshow! To do this, we'll use the Ninja template ([click here for a demo](https://slides.yihui.name/xaringan/#1)) from the `xaringan` package (that's what we use for all of our BaselRBootcamp slides). Install the `xaringan` package by running `install.packages('xaringan')`

28. Once you've installed `xaringan`, open a new template with File -- New File -- R Markdown -- From Template -- Ninja Presentation. Give the presentation a title and your name as the author. Then click ok.

29. You should see a new .Rmd document open. Save the document in your main project directory as `slideshow.Rmd`.

30. Knit the document to see the outline of the presentation!

31. Play around with the presentation a bit. Change the existing content a bit and add a few slides. Try adding an image (maybe this one: https://actgnetwork.org/sites/all/themes/actg/images/actg_logo_275.png) by saving the image to your `0_Materials` folder, and then loading the image into your document with `include_graphics()`.

32. Now, try to customize the presentation to include all of main analyses, outputs, and plots you have in your `speffanalysis.Rmd` document! Of course, there won't be room for all of the text, so treat it like a normal presentation and put in what's important.

### References and Links

- Want to see the .Rmd file that created this practical? You can find it [here](https://raw.githubusercontent.com/therbootcamp/therbootcamp.github.io/master/_sessions/D4S2_DynamicReports/DynamicReports_practical.Rmd).

- The `rmdformats` package has many nice templates for .Rmd files. Look at their GitHub page at [https://github.com/juba/rmdformats](https://github.com/juba/rmdformats) for examples. If you install the package from CRAN with `install.packages('rmdformats')`, you'll get lots of new templates when you open a new Markdown file in RStudio. 

- If you want to use custom .css files, check out the the [R Studio HTML document guide](http://rmarkdown.rstudio.com/html_document_format.html#custom_css). You can also look at the .css files underlying the `rmdformats` package on their GitHub page here [https://github.com/juba/rmdformats](https://github.com/juba/rmdformats). For example, here is their .css file for the "html docco" template [https://raw.githubusercontent.com/juba/rmdformats/master/inst/templates/html_docco/docco.css](https://raw.githubusercontent.com/juba/rmdformats/master/inst/templates/html_docco/docco.css)
