---
title: "Plotting"
author: "BaselRBootcamp July 2018<br/><a href='https://therbootcamp.github.io'>www.therbootcamp.com</a><br/><a href='https://twitter.com/therbootcamp'>@therbootcamp</a>"
output:
  html_document
---

```{r setup, echo = FALSE}
knitr::opts_chunk$set(comment = NA, 
                      fig.width = 6, 
                      fig.height = 6,
                      fig.align = 'center',
                      echo = FALSE, 
                      eval = FALSE, 
                      warning = FALSE,
                      message = FALSE)

options(digits = 3)
```

<figure>
<center>
  <img src="https://d33wubrfki0l68.cloudfront.net/0ab849ed51b0b866ef6895c253d3899f4926d397/dbf0f/images/hex-ggplot2.png" alt="Trulli" style="width:20%">
  <figcaption>https://rstudio.com</figcaption>
</figure>

### Overview

In this practical you'll practice plotting data with the `ggplot2` package. 

## Packages

|Package| Installation|
|:------|:------|
|`tidyverse`|`install.packages("tidyverse")`|
|`ggthemes`|`install.packages("ggthemes")`|
|`skimr`|`install.packages("skimr")`|


### Cheatsheet

<figure>
<center>
<a href="https://www.rstudio.com/wp-content/uploads/2015/03/ggplot2-cheatsheet.pdf">
  <img src="http://www.rstudio.com/wp-content/uploads/2015/03/ggplot2-cheatsheet.png" alt="Trulli" style="width:70%">
  <figcaption>https://www.rstudio.com/wp-content/uploads/2015/03/ggplot2-cheatsheet.pdf</figcaption></a>
</figure>



### Examples

- The following examples will take you through the steps of creating both simple and complex plots with `ggplot2`. Try to go through each line of code and see how it works!

```{r, eval = FALSE, echo = TRUE}
# -----------------------------------------------
# Examples of using ggplot2 on the mpg data
# ------------------------------------------------

library(tidyverse)         # Load tidyverse (which contains ggplot2!)

mpg # Look at the mpg data

# Just a blank space without any aesthetic mappings
ggplot(data = mpg)

# Now add a mapping where engine displacement (displ) and highway miles per gallon (hwy) are mapped to the x and y aesthetics
ggplot(data = mpg, 
       mapping = aes(x = displ, y = hwy))   # Map displ to x-axis and hwy to y-axis

#  Add points with geom_point()
ggplot(data = mpg, 
       mapping = aes(x = displ, y = hwy)) +
       geom_point()     

#  Add points with geom_count()
ggplot(data = mpg, 
       mapping = aes(x = displ, y = hwy)) +
       geom_count()   

# Again, but with some additional arguments
# Also using a new theme temporarily

ggplot(data = mpg, 
       mapping = aes(x = displ, y = hwy)) +
       geom_point(col = "red",                  # Red points
                  size = 3,                     # Larger size
                  alpha = .5,                   # Transparent points
                  position = "jitter") +        # Jitter the points         
         scale_x_continuous(limits = c(1, 15)) +  # Axis limits
         scale_y_continuous(limits = c(0, 50)) +
  theme_minimal()


# Assign class to the color aesthetic and add labels with labs()

ggplot(data = mpg, 
  mapping = aes(x = displ, y = hwy, col = class)) +  # Change color based on class column
  geom_point(size = 3, position = 'jitter') +
  labs(x = "Engine Displacement in Liters",
       y = "Highway miles per gallon",
       title = "MPG data",
       subtitle = "Cars with higher engine displacement tend to have lower highway mpg",
       caption = "Source: mpg data in ggplot2")
  

# Add a regression line for each class

ggplot(data = mpg, 
       mapping = aes(x = displ, y = hwy, color = class)) +
  geom_point(size = 3, alpha = .9) + 
  geom_smooth(method = "lm")

# Add a regression line for all classes

ggplot(data = mpg, 
       mapping = aes(x = displ, y = hwy, color = class)) +
  geom_point(size = 3, alpha = .9) + 
  geom_smooth(col = "blue", method = "lm")


# Facet by class
ggplot(data = mpg,
       mapping = aes(x = displ, 
                     y = hwy, 
                     color = factor(cyl))) + 
  geom_point() +
  facet_wrap(~ class) 


# Another fancier example

ggplot(data = mpg, 
       mapping = aes(x = cty, y = hwy)) + 
       geom_count(aes(color = manufacturer)) +     # Add count geom (see ?geom_count)
       geom_smooth() +                   # smoothed line without confidence interval
       geom_text(data = filter(mpg, cty > 25), 
                 aes(x = cty,y = hwy, 
                     label = rownames(filter(mpg, cty > 25))),
                     position = position_nudge(y = -1), 
                                check_overlap = TRUE, 
                     size = 5) + 
       labs(x = "City miles per gallon", 
            y = "Highway miles per gallon",
            title = "City and Highway miles per gallon", 
            subtitle = "Numbers indicate cars with highway mpg > 25",
            caption = "Source: mpg data in ggplot2",
            color = "Manufacturer", 
            size = "Counts")
```

## Tasks


### Datasets

```{r, eval = TRUE, message = FALSE}
library(tidyverse)
mcdonalds <- read_csv("../_data/complete/mcdonalds.csv")
```

|File | Rows | Columns |
|:----|:-----|:------|
|`mcdonalds.csv` | 260 | 24 |



## A - Setup

A1. Open your R project. It should already have the folders `0_Data` and `1_Code`. Make sure that the data files listed in the `Datasets` section above are in your `1_Data` folder

```{r}
# Done!
```

A2. Open a new R script. At the top of the script, using comments, write your name and the date. Save it as a new file called `plottingh_practical.R` in the `2_Code` folder.  

A3. Using `library()` load the set of packages for this practical listed in the packages section above.

```{r, eval = FALSE, echo = TRUE}
## NAME
## DATE
## Wrangling Practical

library(XX)     
library(XX)
#...
```

```{r, message = FALSE, warning = FALSE, echo = FALSE, eval = TRUE}
library(tidyverse)
library(skimr)
```

A4. For this practical, we'll use the `mcondalds` data which contains nutrition information about items from McDonalds. Using the following template, load the data into R and store it as a new object called `mcdonalds`.

```{r, echo = TRUE, eval = FALSE, message = FALSE, warning = FALSE}
# Load mcdonalds.csv from the data folder in your working directory

mcdonalds <- read_csv(file = "XXX/XXX")
```

```{r, message = FALSE, echo = FALSE, eval = TRUE, warning = FALSE}
library(tidyverse)
```

A6. Take a look at the first few rows of the dataset(s) by printing them to the console.

A7. Use the `skim()` function (from the `skimr` package) to get more details on the dataset(s).

### B - Building a plot step-by-step

In this section, you'll build the following plot step by step

```{r, echo = FALSE, eval = TRUE, fig.width = 7, fig.height = 4}
ggplot(mcdonalds, aes(x = Calories, y = `Saturated Fat (% Daily Value)`, col = Category)) +
  geom_point() +
  geom_smooth(col = "black") +
  labs(title = "McDonalds Nutrition",
       subtitle = "Each point is a menu item",
       caption = "Source: Kaggle.com") +
  xlim(0, 1250) +
  theme_minimal()
```

B1. Using `ggplot()`, create the following blank plot using the `data` and `mapping` arguments (but no geom). Use `calories` for the x aesthetic and `saturated_fat` for the y aesthetic

```{r, echo = TRUE, eval = FALSE, fig.width = 6, fig.height = 4}
ggplot(data = mcdonalds, 
       mapping = aes(x = XX, y = XX))
```

```{r, echo = FALSE, eval = TRUE, fig.width = 7, fig.height = 4}
ggplot(mcdonalds, aes(x = Calories, y = `Saturated Fat (% Daily Value)`))
```

B1. Using `geom_point()`, add points to the plot

```{r, echo = TRUE, eval = FALSE, fig.width = 6, fig.height = 4}
ggplot(data = mcdonalds, 
       mapping = aes(x = XX, y = XX)) +
  geom_point()
```

```{r, echo = FALSE, eval = TRUE, fig.width = 7, fig.height = 4}
ggplot(mcdonalds, aes(x = Calories, y = `Saturated Fat (% Daily Value)`)) +
  geom_point()
```

B2. Using the `color` aesthetic mapping, color the points by their Category.

```{r, echo = TRUE, eval = FALSE, fig.width = 6, fig.height = 4}
ggplot(mcdonalds, aes(x = XX, y = XX, col = XX)) +
  geom_point() 
```

```{r, echo = FALSE, eval = TRUE, fig.width = 7, fig.height = 4}
ggplot(mcdonalds, aes(x = Calories, y = `Saturated Fat (% Daily Value)`, col = Category)) +
  geom_point()
```

B3. Add a smoothed average line using `geom_smooth()`.

```{r, echo = TRUE, eval = FALSE, fig.width = 6, fig.height = 4}
ggplot(mcdonalds, aes(x = XX, y = XX, col = XX)) +
  geom_point() +
  geom_smooth() 
```

```{r, echo = FALSE, eval = TRUE, fig.width = 7, fig.height = 4}
ggplot(mcdonalds, aes(x = Calories, y = `Saturated Fat (% Daily Value)`, col = Category)) +
  geom_point() +
  geom_smooth()
```

B3. Oops! Did you get several smoothed lines instead of just one? Let's fix it by specifying that the line should have one color: "black". When you do, you should then only see one line.

```{r, echo = TRUE, eval = FALSE, fig.width = 6, fig.height = 4}
ggplot(mcdonalds, aes(x = XX, y = XX, col = XX)) +
  geom_point() +
  geom_smooth(col = "XX") 
```


```{r, echo = FALSE, eval = TRUE, fig.width = 7, fig.height = 4}
ggplot(mcdonalds, aes(x = Calories, y = `Saturated Fat (% Daily Value)`, col = Category)) +
  geom_point() +
  geom_smooth(col = "black")
```

B4. Add appropriate labels using the `labs()` function

```{r, echo = TRUE, eval = FALSE, fig.width = 8, fig.height = 2}
ggplot(mcdonalds, aes(x = XX, y = XX, col = XX)) +
  geom_point() +
  geom_smooth(col = "XX") +
  labs(title = "XX",
       subtitle = "XX",
       caption = "XX")
```

```{r, echo = FALSE, eval = TRUE, fig.width = 7, fig.height = 4}
ggplot(mcdonalds, aes(x = Calories, y = `Saturated Fat (% Daily Value)`, col = Category)) +
  geom_point() +
  geom_smooth(col = "black") +
  labs(title = "McDonalds Nutrition",
       subtitle = "Each point is a menu item",
       caption = "Source: Kaggle.com")
```

B5. Set the limits of the x-axis to 0 and 1250 using `xlim()`

```{r, echo = TRUE, eval = FALSE, fig.width = 8, fig.height = 2}
ggplot(mcdonalds, aes(x = XX, y = XX, col = XX)) +
  geom_point() +
  geom_smooth(col = "XX") +
  labs(title = "XX",
       subtitle = "XX",
       caption = "XX") +
  xlim(XX, XX)
```

```{r, echo = FALSE, eval = TRUE, fig.width = 7, fig.height = 4}
ggplot(mcdonalds, aes(x = Calories, y = `Saturated Fat (% Daily Value)`, col = Category)) +
  geom_point() +
  geom_smooth(col = "black") +
  labs(title = "McDonalds Nutrition",
       subtitle = "Each point is a menu item",
       caption = "Source: Kaggle.com") +
  xlim(0, 1250)
```

B5. Finally, set the plotting theme to `theme_minimal()`. You should now have the final plot!

```{r, echo = TRUE, eval = FALSE, fig.width = 8, fig.height = 2}
ggplot(mcdonalds, aes(x = XX, y = XX, col = XX)) +
  geom_point() +
  geom_smooth(col = "XX") +
  labs(title = "XX",
       subtitle = "XX",
       caption = "XX")+
  xlim(XX, XX) +
  theme_minimal()
```

```{r, echo = FALSE, eval = TRUE, fig.width = 7, fig.height = 4}
ggplot(mcdonalds, aes(x = Calories, y = `Saturated Fat (% Daily Value)`, col = Category)) +
  geom_point() +
  geom_smooth(col = "black") +
  labs(title = "McDonalds Nutrition",
       subtitle = "Each point is a menu item",
       caption = "Source: Kaggle.com") +
  xlim(0, 1250) +
  theme_minimal()
```


### C - Playing with geoms

C1. Create the following plot showing the relationship between menu category and calories

```{r, eval = TRUE, echo = FALSE, fig.width = 8, fig.height = 3}
ggplot(data = mcdonalds, aes(x = Category, y = Calories, fill = Category)) +
  geom_violin() +
  guides(fill = FALSE) +
  labs(title = "McDonalds",
       subtitle = "Calorie distribution by menu category")
```

```{r, eval = FALSE, echo = TRUE, fig.width = 8, fig.height = 3}
ggplot(data = mcdonalds, aes(x = XX, y = XX, fill = XX)) +
  geom_violin() +
  guides(fill = FALSE) +
  labs(title = "XX",
       subtitle = "XX")
```

C2. Include the additional argument `+ stat_summary(fun.y = "mean", geom = "point", col = "white", size = 4)` to include points showing the mean of each distribution

```{r, eval = TRUE, echo = FALSE, fig.width = 8, fig.height = 3}
ggplot(data = mcdonalds, aes(x = Category, y = Calories, fill = Category)) +
  geom_violin() +
  guides(fill = FALSE) +
  stat_summary(fun.y = "mean", geom = "point", col = "white", size = 4) +
  labs(title = "McDonalds",
       subtitle = "Calorie distribution by menu category")
```

C3. Now add `+ geom_jitter(width = .1, alpha = .5)` to your plot, what do you see?

```{r, eval = TRUE, echo = FALSE, fig.width = 8, fig.height = 3}
ggplot(data = mcdonalds, aes(x = Category, y = Calories, fill = Category)) +
  geom_violin() +
  geom_jitter(width = .1, alpha = .5) +
  guides(fill = FALSE) +
  stat_summary(fun.y = "mean", geom = "point", col = "white", size = 4) +
  labs(title = "McDonalds",
       subtitle = "Calorie distribution by menu category")
```

C4. Play around with your plotting arguments to see how the results change! Each time you make a change, run the plot again to see your new output!

    - Change the summary function in `stat_summary()` from "mean" to "median"
    - Change the size of the points in `stat_summary()` to something much biggger (or smaller).
    - Change the `width` argument in `geom_jitter()` to `width = 0`
    - Instead of using `geom_violin()`, try `geom_boxplot()`
    - Remove the `fill = Category` aesthetic entirely.

### D - Using facets

D1. Create the following plot showing the relationship between Sodium and calories

```{r, eval = TRUE, echo = FALSE}
ggplot(mcdonalds, aes(x = Sodium, y = Calories)) +
  geom_point(alpha = .2) +
  facet_wrap(~Category) +
  labs(title = "McDonales",
       subtitle = "Sodium vs. Calories") +
  theme_minimal()
```

```{r, eval = FALSE, echo = TRUE}
ggplot(XX, aes(x = XX, y = XX)) +
  geom_point(alpha = .2) +
  facet_wrap(~ XX) +
  labs(title = "XX",
       subtitle = "XX") +
  theme_minimal()
```

D2. Try the following ways to customise your plot

  - Color the points by their category
  - Add a smoothed line to each plot with `geom_smooth()`


### E - Saving plots

E1. 

### E - Playing with themes

E1. the `ggthemes` package has many additional plotting themese. Look at the help menu for the `ggthemes` package to see all of the themes.

E2. Adjust some of your previous plots using the `theme_excel()` theme to see a really ugly Excel-like plot!






### Saving plots as objects

19. Create the following plot from the `mpg` dataset, and save it as an object called `myplot`

```{r, echo = FALSE, eval = TRUE, fig.width = 6, fig.height = 4}

myplot <- ggplot(data = mpg,
                 aes(x = cty, y = hwy)) +
  geom_point() +
  labs(x = "City Miles per Gallon",
       y = "Highway Miles per Gallon",
       title = "mpg data")

myplot
```


20. Now, using object assignment `<-` add a regression line to the `myplot` object with `geom_smooth()`. Then evaluate the object to see the updated version. It should now look like this:

```{r, echo = FALSE, eval = TRUE, fig.width = 6, fig.height = 4}
myplot + geom_smooth()
```

21. Using `ggsave()`, save the object as a pdf file called `myplot.pdf` in your `3_Figures` folder. Set the width to 6 inches, and the height to 4 inches. Open the pdf outside of RStudio to make sure it worked!

### Demographic information of midwest counties in the US

22. Print the `midwest` dataset (it's contained in ggplot2) and look at the help menu to see what values it contains. It should look like this:

```{r, eval = TRUE}
midwest
```

23. Using the following code as a template, create the following plot showing the relationship between college education and poverty

```{r, echo = TRUE, eval = FALSE, fig.width = 7, fig.height = 5}
ggplot(data = XX, 
    mapping = aes(x = XX, y = XX)) + 
    geom_point(aes(fill = XX, size = XX), shape = 21, color = "white") + 
    geom_smooth(aes(x = XX, y = XX)) +
    labs(
        x = "XX", 
        y = "XX", 
        title = "XX",
        subtitle = "XX",
        caption = "XX") + 
    scale_color_brewer(palette = "XX") + 
    scale_size(range = c(XX, XX)) +
    guides(size = guide_legend(override.aes = list(col = "black")), 
           fill = guide_legend(override.aes = list(size = 5)))
```


```{r, echo = FALSE, eval = TRUE, fig.width = 8, fig.height = 5}
ggplot(data = midwest, 
    mapping = aes(x = percollege, y = percpovertyknown)) + 
    geom_point(aes(fill = state, size = popdensity), shape = 21, color = "white") + 
    geom_smooth(aes(x = percollege, y = percpovertyknown)) +
    labs(
        x = "Percent with college education", 
        y = "Poverty rate", 
        title = "Midwest Data",
        subtitle = "States with higher college education rates tend to have lower poverty rates",
        caption = "Source: ggplot2 package") + 
    scale_color_brewer(palette = "Set1") + 
    scale_size(range = c(0, 12)) +
    guides(size = guide_legend(override.aes = list(col = "black")), 
           fill = guide_legend(override.aes = list(size = 5)))
```


24. Create the following density plot showing the density of inhabitants with a college education in different states using the following template

```{r, echo = TRUE}
ggplot(data = XX, 
       mapping = aes(XX, fill = XX)) + 
  geom_density(alpha = XX) + 
  labs(title = "XX", 
       subtitle = "XX",
       caption = "XX",
       x = "XX",
       y = "XX",
       fill = "XX")
```


```{r, echo = FALSE, eval = TRUE, fig.width = 8, fig.height = 5}
ggplot(data = midwest, 
       mapping = aes(percollege, fill = state)) + 
  geom_density(alpha = 0.8) + 
  labs(title = "College education rates", 
       subtitle = "For 5 Midwest states",
       caption = "Source: midwest dataset in ggplot2",
       x = "Percent of inhabitants with a college education",
       y = "Density",
       fill = "State") + 
  theme_bw()
```

### Heatplots with `geom_tile()`

25. You can create heatplots using the `geom_tile()` function. Try creating the following heatplot of statistics of NBA players using the following template:

```{r, echo = TRUE, eval = FALSE}
# Read in nba data
nba_long <- read_csv("https://raw.githubusercontent.com/therbootcamp/therbootcamp.github.io/master/_sessions/_data/nba_long.csv")

# Look at the data
nba_long

ggplot(XX, 
       mapping = aes(x = XX, y = XX, fill = XX)) + 
  geom_tile(colour = "XX") + 
  scale_fill_gradientn(colors = c("XX", "XX", "XX"))+ 
  labs(x = "XX", 
       y = "XX", 
       fill = "XX", 
       title = "NBA XX performance",
       subtitle = "XX",
       caption = "XX") +
  coord_flip()
```


```{r, echo = FALSE, eval = TRUE, fig.width = 10, fig.height = 12}
# Read in nba data
nba_long <- read_csv("https://raw.githubusercontent.com/therbootcamp/therbootcamp.github.io/master/_sessions/_data/nba_long.csv")

ggplot(nba_long, 
       mapping = aes(x = Name, y = measure, fill = value)) + 
  geom_tile(colour = "white") + 
  scale_fill_gradientn(colors = c("red", "white", "blue"))+ 
  labs(x = "Player", 
       y = "Statistic", 
       fill = "Performance", 
       title = "NBA player performance",
       subtitle = "Each tile represents how well the player performed on that statistic relative to other players.",
       caption = "Source: https://learnr.wordpress.com/2010/01/26/ggplot2-quick-heatmap-plotting/") +
  coord_flip() + 
  theme_minimal()
```


26. Make the following plot of savings data (`psavert`) from the `economics` dataset.

```{r, eval = FALSE, echo = FALSE}
ggplot(data = XX, aes(x = XX, y = XX)) + 
       geom_line() + 
       labs(title = "XX", 
            subtitle = "XX", 
            caption = "XX", 
            y = "XX") + 
       geom_smooth()
```

```{r, eval = TRUE, echo = FALSE, fig.width = 10, fig.height = 6}
# plot
ggplot(data = economics, 
       mapping = aes(x = date, y = psavert)) + 
  geom_line() + 
  geom_smooth() +
  labs(title = "Personal Savings Rates Changes over Time", 
       subtitle = "Ratio of personal saving to disposable income", 
       caption = "Source:  http://research.stlouisfed.org/fred2", 
       y = "Savings Rate %") + 
  theme_bw()
```

28. Make the following plot from the `trial_act.csv` dataset. To do this, you'll need to use both `geom_boxplot()` and `geom_point()`. To jitter the points, use the `position` argument to `geom_point()`, as well as the `position_jitter()` function to control how much to jitter the points.


### References and Further Reading

- Many of the plots in this practical were taken from Selva Prabhakaran's website [http://r-statistics.co/Top50-Ggplot2-Visualizations-MasterList-R-Code.html](http://r-statistics.co/Top50-Ggplot2-Visualizations-MasterList-R-Code.html)

- The main `ggplot2` webpage at [http://ggplot2.tidyverse.org/](http://ggplot2.tidyverse.org/) has great tutorials and examples.

- `ggplot2` is also great for making maps. For examples, check out Eric Anderson's page at [http://eriqande.github.io/rep-res-web/lectures/making-maps-with-R.html](http://eriqande.github.io/rep-res-web/lectures/making-maps-with-R.html)
