---
title: "Data I/O"
author: "Basel R Bootcamp, July 2018<br/><a href='https://therbootcamp.github.io'>www.therbootcamp.com</a><br/><a href='https://twitter.com/therbootcamp'>@therbootcamp</a>"
output:
  html_document:
    css: practical.css
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(comment = NA, 
                      fig.width = 6, 
                      fig.height = 6,
                      fig.align = 'center',
                      echo = FALSE, 
                      eval = FALSE, 
                      warning = FALSE)

options(digits = 3)

library(baselers)
library(tidyverse)
```


<figure  alt="Trulli" style="width:90%">
  <center>
  <img src="https://i.pinimg.com/originals/94/e2/98/94e29802d7473690bdbc5acb85a5302d.gif">
  <center>
</figure>


## Overview

In this practical you'll learn how to read and save data. By the end of this practical you will know how to:

1. Identify the location of a file (on your hard drive)
2. Read in data of various types
3. Handle header, type, and missing data issues

## Datasets

```{r, eval = TRUE, message = FALSE}
library(tidyverse)
library(haven)
```

|File | Rows | Columns | Description |
|:----|:-----|:------|:-----------------------------------------|
|[diamonds.csv](https://raw.githubusercontent.com/therbootcamp/BaselRBootcamp_2018July/master/_sessions/_data/complete/diamonds.csv) | 100 | 7 | Subset of the well-known diamonds data set containing specifications and prices of a large number of recorded diamonds.  |
|[titanic.xls](https://raw.githubusercontent.com/therbootcamp/BaselRBootcamp_2018July/master/_sessions/_data/complete/titanic.xls) | 1309 | 14 | Information on the survival of titanic passengers. |
|[sleep.sav](https://raw.githubusercontent.com/therbootcamp/BaselRBootcamp_2018July/master/_sessions/_data/complete/sleep.sav) | 271 | 55 | Survey on sleeping behavior completed by staff at the University of Melbourne. |
|[airbnb_zuerich.sas7bdat](https://raw.githubusercontent.com/therbootcamp/BaselRBootcamp_2018July/master/_sessions/_data/complete/airbnb_zuerich.sas7bdat) | 2392 | 20 | Data on AirBnB listings in Zürich, Switzerland|

## Packages

|Package| Installation|
|:------|:------|
|`tidyverse`|`install.packages("tidyverse")`|
|`readr`|`install.packages("readr")`|
|`haven`|`install.packages("haven")`|
|`readxl`|`install.packages("readxl")`|
|`xml2`|`install.packages("xml2")`|
|`rvest`|`install.packages("rvest")`|

### Glossary

*Reading/writing delim-separated data*

| Function | Description|
|:--------------------------|:-----------------------------|
| `read_csv(file)`, `write_csv(x, file)` | Read/write files separated by comma|
| `read_csv2(file)`, *not available* | Read/write files separated by semicolon|
| `read_delim(file)`, `write_delim(x, file)` | Read/write files separated by arbitrary symbol|

*Reading/writing other data formats*

| Function| Description|
|:--------------------------|:-----------------------------|
| `read_excel(file)`, *not available* | Read Excel files with extension `.xls` and `.xlsx` |
| `read_spss(file)`, `write_spss(x, file)`| Read/write SPSS files with extension `.sav` |
| `read_sas(file)`, `write_sas(x, file)`| Read/write SAS files with extension `.sas7bdat` |

*Processing websites*

| Function| Description|
|:--------------------------|:-----------------------------|
| `read_html(file)`, `write_html(x, file)`| Read/write websites files with extension `.html` |
| `hmlt_node(html)` | Select specific element in `.html`-file |
| `html_table` | Transform `.html`-table to data frame |


### Examples

```{r, eval = FALSE, echo = TRUE, message = FALSE, warning = FALSE}
# load packages
library(tidyverse)
library(readxl)
library(haven)

# delim-separated -------------------

# read survey data
survey <- read_csv("1_Data/survey.csv")

# fix header by specifying column names
survey <- read_csv("1_Data/survey.csv",
                   col_names = c("id", "age", "sex", "rating"))

# fix NA values
survey <- read_csv("1_Data/survey.csv",
                   col_names = c("id", "age", "sex", "pol"),
                   na = c('NA', 'NULL'))

# write clean data to disc
write_csv(survey, "1_Data/clean_survey.csv")

# fix types -------------------

# remove character from rating
survey$rating[survey$rating == "2,1"] <- 2.1

# rerun type convert
survey <- type_convert(survey)

# other formats -------------------

survey <- read_excel("1_Data/survey.xml")
survey <- read_spss("1_Data/survey.sav")
survey <- read_sas("1_Data/survey.sas7bdat")

# scraping the web ----------------

# load package
library(tidyverse)
library(rvest)
library(xml2)

# get html
url <- 'https://en.wikipedia.org/wiki/R_(programming_language)' 
page <- read_html(url)

# get raw html table
# use XPath from inspect page (e.g., in Chrome)
table_raw = html_node(page, xpath = '//*[@id="mw-content-text"]/div/table[2]')

# transform to data frame
table <- html_table(table_raw)

# create tibble
as_tibble(table)
```

# Tasks

## A - Read delim-separated text files

In this section, you will read in a subset of the well known diamonds data set and prepare it for data analysis. 

1. Identify the file path to the `diamonds.csv` dataset by using the `""` (quotation marks) auto-complete trick. Place the cursor between two quotation marks, hit &#8677; (tab-key), and browse through the file. Save the file path in an object called path.

```{r, eval = F, echo =T}
# place cursor in-between "" and hit tab
path <- ""
```


```{r, eval = F, echo = T}
# place cursor in-between and hit tab
path <- "1_Data/diamonds.csv"
```

2. Using `read_csv()` and the `path` object, read the `diamonds.csv` dataset. Make sure to first load the `tidyverse`. 

```{r, eval = F, echo = T}
# load tidyverse
library(tidyverse)

# read diamonds data
diamonds <- read_csv(XX)
```

```{r, eval = F, echo = F}
# load tidyverse
library(tidyverse)

# read diamonds data
diamonds <- read_csv(path)
```

3. Print the diamonds data and inspect the column names in the header line. Something's wrong!

```{r, eval = F, echo = F}
# print diamonds
diamonds
```

4. Fix the header by reading in the data again using the `col_names`-argument. Assign to `col_names` a character vector containing the correct column names: `carat`, `cut`, `color`, `clarity`, `depth`, `table`, `price`.

```{r, eval = F, echo = T}
# read diamonds data while specifying col_names
diamonds <- read_csv(XX, col_names = XX)
```

```{r, eval = F, echo = F}
# read diamonds data while specifying col_names
diamonds <- read_csv(path,
                     col_names = c("carat", "cut", "color", "clarity", "depth", "table", "price"))
```

5. Re-inspect the header by printing the data. Has the header been fixed?

```{r, eval = F, echo = F}
# print diamonds
diamonds
```

6. Now pay attention to the classes of the individuals columns (variables). Have all classes been identified correctly? Should `carat` not be a numeric variable?

```{r, eval = F, echo = F}
# print diamonds
diamonds
```

7. Select and print the `carat` variable to identify the one entry that caused the variable to become a character vector. (hint: look for a comma). 

```{r, eval = F, echo = F}
# print the carat column
diamonds$carat
```

8. Change the carat variable's element at position `XX` to same value `YY` but with a period instead of a comma. Use the code below.  

```{r, eval = F, echo = T}
# Change the value at position XX to YY
diamonds$carat[XX] <- YY
```

```{r, eval = F, echo = F}
# Change the value at position XX to YY
diamonds$carat[17] <- 0.37
```

9. Now, run `type_convert` on the `diamonds` data to have R re-infer and fix the data types. 

```{r, eval = F, echo = F}
# re-infer data types
diamonds <- type_convert(diamonds)
```

10. Inspect the message that was printed in the console. Has the type of `carat` changed in `double`? Verify by printing the dataset.

```{r, eval = F, echo = F}
# print diamonds data set
diamonds
```

11. The data is now ready for analysis. Calculate a few statistics. What is the average `carat` or `price` (use `mean()`)? What cut `cut` and `clarity` levels exist and how often do they occur (use `table()`)? You can learn more about the variable values from the help file `?diamonds`.

```{r, eval = F, echo = F}
# simple stats of diamonds
mean(diamonds$carat)
mean(diamonds$price)
table(diamonds$cut)
table(diamonds$clarity)
```

## B - Write delim-separated text files

1. Write the, now, properly formatted diamonds data to your data folder as a `.csv` file using the name   `diamonds_clean.csv`. Don't forget to include both the file name and the folder (separated by `/`) in the character string specifying the `path` argument. 

```{r, eval = F, echo = F}
# write clean diamonds data to disc
write_csv(XX, path = XX)
```

```{r, eval = F, echo = F}
# write clean diamonds data to disc
write_csv(diamonds, "1_Data/diamonds_clean.csv")
```

2. Read `diamonds_clean.csv` back in and call the object `diamonds_clean`. Verify that this time the types been correctly identified from the start.

```{r, eval = F, echo = F}
# read clean diamonds data from disc
diamonds_clean <- read_csv("1_Data/diamonds_clean.csv")
```

3. Using `write_delim`, write the data to disc with a different delimiter calling it `diamonds_delim.csv`. Specifically, set the `delim`-argument to `@`.

```{r, eval = F, echo = F}
# write with @ as delimiter
write_delim(XX, path = XX, delim = XX)
```

```{r, eval = F, echo = F}
# write with @ as delimiter
write_delim(diamonds_clean, path = "1_Data/diamonds_delim.csv", delim = "@")
```

4. Read `diamonds_delim.csv` back in using `read_csv()`. What happens?

```{r, eval = F, echo = F}
# read @-delimited diamonds data
read_csv("1_Data/diamonds_delim.csv")
```

5. Fix the delimiter issue by using `read_delim()` instead of `read_csv()` and specifying the `delim`-argument. Verify that everything is in order again by printing the data.

```{r, eval = F, echo = F}
# read @-delimited diamonds data
read_delim("1_Data/diamonds_delim.csv", delim = "@")
```

## C - Read other file formats

**Excel**

1. Using `read_excel()`, read in the `titanic.xls` dataset. Make sure to first load the `readxl` package.

```{r, eval = F, echo = T}
titanic <- read_excel(XX)
```

```{r, eval = F, echo = F}
# Read titanic data
titanic <- read_excel("1_Data/titanic.xls")
```

2. Print it and evaluate its dimensions using `dim()`.

```{r, eval = F, echo = F}
# print and show dimenisons
titanic
dim(titanic)
```

3. Using `table()`, how many people survived (variable `survived`) in each cabin class (variable `pclass`)?

```{r, eval = F, echo = T}
# determine survival rate by cabin class
table(titanic$XX, titanic$XX)
```

```{r, eval = F, echo = F}
# determine survival rate by cabin class
table(titanic$pclass, titanic$survived)
```

4. Write data to your data folder using `write_csv()`.

```{r, eval = F, echo = F}
# write data to .csv
write_csv(titanic, "1_Data/titanic.csv")
```

**SPSS**

5. Using `read_spss()` read in the sleep data set `sleep.sav` of staff at he University of Melbourne. Make sure to first load the `haven` package.

```{r, eval = F, echo = T}
XX <- read_spss(XX)
```

```{r, eval = F, echo = F}
# Read sleep data
sleep <- read_spss("1_Data/sleep.sav")
```

6. Print it and evaluate its dimensions using `dim()`.

```{r, eval = F, echo = F}
# print and show dimenisons
sleep
dim(sleep)
```

7. How many drinks do staff at the University of Melbourne consumer per day (variable `alcohol`). Use the `mean()`-function, while taking care of missing values using the `na.rm`-argument. 

```{r, eval = F, echo = F}
# compute mean number of drinks
mean(sleep, na.rm = TRUE)
```

8. Write data to your data folder using `write_csv()`.

```{r, eval = F, echo = F}
# write data to .csv
write_csv(sleep, "1_Data/sleep.csv")
```


**SAS**

9. Using `read_sas()`, read in `airbnb_zuerich.sas7bdat` containing AirBnB listings in Zürich, Switzerland and call the object `airbnb_zuerich`.

```{r, eval = F, echo = T}
# read sas data
XX <- read_sas(XX)
```

```{r, eval = F, echo = F}
# read airbnb_zuerich.sas7bdat
airbnb_zuerich <- read_sas("1_Data/airbnb_zuerich.sas7bdat")
```

10. Print it and evaluate its dimensions using `dim()`.

```{r, eval = F, echo = F}
# print and show dimenisons
airbnb_zuerich
dim(airbnb_zuerich)
```

11. Using `table()`, determine how many AirBnB listings of which `room_type` exist in Zürich?

```{r, eval = F, echo = F}
# table room type
table(airbnb_zuerich$room_type)
```

12. Write data to your data folder using `write_csv()`.

```{r, eval = F, echo = F}
# write data to .csv
write_csv(airbnb_zuerich, "1_Data/airbnb_zuerich.csv")
```

## D - Use R's data format

R has two data formats of its own - `.Rdata` and `.RDS`. We recommend to use only `.RData` as its use follows the same logic as with other read and write functions. A benefit of using R's data formats is compression, leading to often substantially smaller file sizes. 

1. First, using `read_csv()` read back in the `diamonds_clean.csv` dataset. 

```{r, eval = F, echo = F}
# read diamonds_clean.csv
diamonds_clean <- read_csv("1_Data/diamonds_clean.csv")
```

2. Using `saveRDS()` write `diamonds_clean` to an ´.RDS´-file into your data folder. The function works analogue to other write functions. Make sure to use `.RDS` as the file ending.

```{r, eval = F, echo = T}
# write to RDS
saveRDS(XX, file = XX)
```

```{r, eval = F, echo = F}
# write to RDS
saveRDS(diamonds_clean, file = "1_Data/diamonds_clean.RDS")
```

3. Using `readRDS()`, read `diamonds_clean.RDS` and inspect the data to verify the data has not changed.

```{r, eval = F, echo = F}
# read from RDS
readRDS("1_Data/diamonds_clean.RDS")
```

4. Using `file.size()`, compare the file size of `diamonds_clean.csv` and `diamonds_clean.RDS`. Which file is larger?

```{r, eval = F, echo = F}
# read from RDS
file.size("1_Data/diamonds_clean.csv")
file.size("1_Data/diamonds_clean.RDS")
```

## X - Scraping the internet

1. Finally on to something completely new. These days a lot of data is available not come in a ready-made, spreadsheet-like form, but must be extracted and processed in order to be used. One such data source is the world wide web. The code below based on the `rvest` and `xml2` packages shows a short example of how to extract a table from R's Wikipedia page. Run the code and experience how easy it is to extract data from a webpage.

```{r, eval=F, echo=T}
# load package
library(tidyverse)
library(rvest)
library(xml2)

# get html
url <- 'https://en.wikipedia.org/wiki/R_(programming_language)' 
page <- read_html(url)

# get raw html table
# use XPath from inspect page (e.g., in Chrome)
table_raw = html_node(page, xpath = '//*[@id="mw-content-text"]/div/table[2]')

# transform to data frame
table <- html_table(table_raw)

# create tibble
as_tibble(table)
```

2. If you like, tweak the code to extract tables from other websites. The only things you need to change is the `url` and the `xpath` location. To extract the latter, use the feature of *Chrome* or *Firefox* to show you the html code for a given webpage element. To access the html code right-click on the website element of interest and select `Inspect` or `Inspect element` depending on whether you use Chrome or Firefox. Next right-click on the currently marked element in the html code pane and select `Copy/Copy XPath` or `Copy/XPath` again depending on the browser. Now, you can insert the `XPath` location into your code using `cmd + v` (Mac) or `ctrl + v`. If the code does not work, you probably selected the wrong element. Look out for an element called, e.g., `<table class="wikitable">`, in the case of *Wikipedia*. 


## Additional Resources

- For more information on reading and writing see Grolemund`s and Wickham's [R for Data Science](http://r4ds.had.co.nz/data-import.html).